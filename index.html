<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metas Time de Marketing</title>
    
    <!-- Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração do Tailwind para cores customizadas -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' },
            }
          }
        }
      }
    </script>

    <!-- Import Map: Ensina o navegador onde buscar o React e Firebase -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "firebase/analytics": "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js"
      }
    }
    </script>

    <!-- Babel (Para traduzir o código React no navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      body { background-color: #f8fafc; }
      /* Animações simples */
      .animate-in { animation: fadeIn 0.5s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- SEU CÓDIGO DO APP -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          LayoutDashboard, 
          History as HistoryIcon, 
          Save, 
          Edit3, 
          CheckCircle2, 
          AlertCircle, 
          TrendingUp, 
          Award, 
          Target, 
          Video, 
          Scissors, 
          FileClock, 
          Archive, 
          Palette, 
          Layers, 
          Cloud, 
          RefreshCw, 
          Trophy, 
          ArrowRight, 
          Zap,
          Calculator,
          BarChart3,
          Upload,
          PlusCircle,
          AlertTriangle,
          Database,
          WifiOff
        } from 'lucide-react';

        // --- CONFIGURAÇÃO DO FIREBASE ---
        import { initializeApp } from "firebase/app";
        import { getAnalytics, isSupported } from "firebase/analytics";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { 
          getFirestore, 
          doc, 
          setDoc, 
          onSnapshot, 
          collection, 
          addDoc, 
          deleteDoc, 
          query, 
          orderBy,
          getDocs,
          where
        } from "firebase/firestore";

        // SEUS DADOS REAIS
        const firebaseConfig = {
          apiKey: "AIzaSyBOOUxZfHRHwiYJajuVO6Hue1DEvgSnfZo",
          authDomain: "dash-fire-8211a.firebaseapp.com",
          projectId: "dash-fire-8211a",
          storageBucket: "dash-fire-8211a.firebasestorage.app",
          messagingSenderId: "801513367720",
          appId: "1:801513367720:web:8a07e6630436d8819cfa9d",
          measurementId: "G-40XCB14MN2"
        };

        // Inicialização
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'marketing-dash-prod'; // ID fixo para produção

        // Analytics Seguro
        isSupported().then(yes => yes && getAnalytics(app)).catch(() => {});

        // --- COMPONENTES VISUAIS ---
        const Card = ({ children, className = "" }) => (
          <div className={`bg-white rounded-xl shadow-sm border border-slate-200 p-6 ${className}`}>
            {children}
          </div>
        );

        const StatCard = ({ title, value, icon: Icon, subtext, colorClass = "text-slate-600" }) => (
          <Card className="flex flex-col justify-between h-full hover:shadow-md transition-shadow">
            <div className="flex justify-between items-start mb-2">
              <h3 className="text-sm font-medium text-slate-500 uppercase tracking-wider">{title}</h3>
              <div className={`p-2 rounded-lg bg-slate-50 ${colorClass}`}>
                <Icon size={20} />
              </div>
            </div>
            <div>
              <div className="text-3xl font-bold text-slate-900">{value}</div>
              {subtext && <p className="text-xs text-slate-400 mt-1">{subtext}</p>}
            </div>
          </Card>
        );

        // --- COMPONENTE DE PROJEÇÃO E STATUS ---
        const GoalTracker = ({ current, approval, adjustment, min, meta, superMeta }) => {
          const projectedTotal = current + approval + adjustment;
          
          let nextGoalValue = min;
          let status = "initial"; 

          if (current < min) {
            status = "initial";
            nextGoalValue = min;
          } else if (current < meta) {
            status = "min_reached";
            nextGoalValue = meta;
          } else if (current < superMeta) {
            status = "meta_reached";
            nextGoalValue = superMeta;
          } else {
            status = "super_reached";
            nextGoalValue = current * 1.2;
          }

          const missingPoints = Math.max(0, nextGoalValue - current);
          const isSuper = status === "super_reached";

          let projectionStatusText = "Ainda abaixo da Mínima";
          let projectionColor = "text-slate-400";
          
          if (projectedTotal >= superMeta) {
            projectionStatusText = "Alcança a SUPER META!";
            projectionColor = "text-purple-600 font-bold";
          } else if (projectedTotal >= meta) {
            projectionStatusText = "Alcança a META!";
            projectionColor = "text-emerald-600 font-bold";
          } else if (projectedTotal >= min) {
            projectionStatusText = "Alcança a Mínima";
            projectionColor = "text-amber-600 font-bold";
          }

          return (
            <div className="w-full">
              <div className="flex flex-col md:flex-row items-center justify-between mb-6 gap-4">
                <div>
                  <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wide mb-1">Status Atual (Realizado)</h2>
                  <div className="text-4xl md:text-5xl font-extrabold text-slate-800 flex items-center gap-2">
                    {current} <span className="text-lg text-slate-400 font-medium">pts</span>
                  </div>
                </div>

                {!isSuper && (
                  <div className={`flex items-center gap-4 px-5 py-3 rounded-2xl border-2 ${
                    status === 'initial' ? 'bg-amber-50 border-amber-100' : 
                    status === 'min_reached' ? 'bg-emerald-50 border-emerald-100' : 'bg-purple-50 border-purple-100'
                  }`}>
                    <div className="text-right">
                      <div className="text-[10px] font-bold uppercase text-slate-500 mb-1">Faltam</div>
                      <div className="text-2xl font-black text-slate-800 leading-none">{missingPoints}</div>
                    </div>
                    <ArrowRight className="text-slate-300" size={20} />
                    <div className="text-left">
                      <div className="text-[10px] font-bold uppercase text-slate-500 mb-1">Para Próxima Meta</div>
                      <div className={`text-lg font-black leading-none ${
                        status === 'initial' ? 'text-amber-600' : 
                        status === 'min_reached' ? 'text-emerald-600' : 'text-purple-600'
                      }`}>
                        {status === 'initial' ? min : status === 'min_reached' ? meta : superMeta}
                      </div>
                    </div>
                  </div>
                )}
              </div>

              <div className="relative pt-6 pb-2 mb-8">
                <div className="h-4 bg-slate-100 rounded-full w-full flex overflow-hidden">
                  <div className="h-full bg-amber-200 relative border-r border-white" style={{ width: `${(min / superMeta) * 80}%` }}>
                    <div className="absolute inset-0 bg-amber-500 transition-all duration-1000" style={{ width: `${Math.min((current / min) * 100, 100)}%` }}></div>
                  </div>
                  <div className="h-full bg-emerald-200 relative border-r border-white" style={{ width: `${((meta - min) / superMeta) * 80}%` }}>
                    {current > min && <div className="absolute inset-0 bg-emerald-500 transition-all duration-1000" style={{ width: `${Math.min(((current - min) / (meta - min)) * 100, 100)}%` }}></div>}
                  </div>
                  <div className="h-full bg-purple-200 relative" style={{ width: `${((superMeta - meta) / superMeta) * 80}%` }}>
                    {current > meta && <div className="absolute inset-0 bg-purple-600 transition-all duration-1000" style={{ width: `${Math.min(((current - meta) / (superMeta - meta)) * 100, 100)}%` }}></div>}
                  </div>
                  <div className="h-full bg-slate-100 flex-1"></div>
                </div>

                <div className="absolute top-0 w-full h-full pointer-events-none">
                  {[
                    { val: min, label: 'MÍN', color: 'amber' },
                    { val: meta, label: 'META', color: 'emerald' },
                    { val: superMeta, label: 'SUPER', color: 'purple' }
                  ].map((m) => (
                    <div key={m.label} className="absolute flex flex-col items-center transform -translate-x-1/2" style={{ left: `${(m.val / superMeta) * 80}%`, top: '-22px' }}>
                      <div className={`text-[10px] font-bold px-1.5 py-0.5 rounded mb-1 ${current >= m.val ? `bg-${m.color}-500 text-white` : 'text-slate-400 bg-slate-100'}`}>
                        {m.label}
                      </div>
                      <div className={`w-px h-8 ${current >= m.val ? `bg-${m.color}-500` : 'bg-slate-300'}`}></div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-slate-50 rounded-xl p-4 border border-slate-200">
                <div className="flex items-center gap-2 mb-3">
                  <Calculator size={16} className="text-indigo-500" />
                  <h3 className="text-sm font-bold text-slate-700 uppercase">Projeção de Cenário (Se tudo for aprovado)</h3>
                </div>
                
                <div className="flex flex-col md:flex-row gap-4 items-center">
                  <div className="flex items-center gap-2 text-sm flex-1 w-full justify-center md:justify-start bg-white p-2 rounded-lg border border-slate-100 shadow-sm">
                    <div className="flex flex-col items-center px-2">
                      <span className="font-bold text-slate-800 text-lg">{current}</span>
                      <span className="text-[10px] text-slate-400 uppercase">Atual</span>
                    </div>
                    <span className="text-slate-300 font-light text-xl">+</span>
                    <div className="flex flex-col items-center px-2">
                      <span className="font-bold text-blue-600 text-lg">{approval}</span>
                      <span className="text-[10px] text-blue-400 uppercase">Aprovação</span>
                    </div>
                    <span className="text-slate-300 font-light text-xl">+</span>
                    <div className="flex flex-col items-center px-2 border-2 border-orange-100 bg-orange-50 rounded">
                      <span className="font-bold text-orange-600 text-lg">{adjustment}</span>
                      <span className="text-[10px] text-orange-400 uppercase">Ajuste</span>
                    </div>
                    <span className="text-slate-400 font-light text-xl">=</span>
                    <div className="flex flex-col items-center px-2">
                      <span className={`font-black text-xl ${projectedTotal >= meta ? 'text-indigo-600' : 'text-slate-600'}`}>{projectedTotal}</span>
                      <span className="text-[10px] text-indigo-400 uppercase font-bold">Total Projetado</span>
                    </div>
                  </div>

                  <div className="text-right pl-4 border-l border-slate-200 min-w-[200px]">
                    <div className="text-xs text-slate-500">Resultado Projetado:</div>
                    <div className={`text-sm ${projectionColor}`}>{projectionStatusText}</div>
                    {projectedTotal < meta && (
                      <div className="text-xs text-slate-400 mt-1">Faltariam ainda: <span className="font-bold text-slate-600">{meta - projectedTotal}</span> pts</div>
                    )}
                  </div>
                </div>

                <div className="mt-4 relative h-2 bg-slate-200 rounded-full overflow-hidden w-full">
                  <div className="absolute top-0 bottom-0 bg-slate-400" style={{ left: 0, width: `${(current / superMeta) * 80}%` }}></div>
                  <div className="absolute top-0 bottom-0 bg-blue-400 opacity-70" style={{ left: `${(current / superMeta) * 80}%`, width: `${(approval / superMeta) * 80}%` }}></div>
                  <div className="absolute top-0 bottom-0 bg-orange-400 opacity-70" style={{ left: `${((current + approval) / superMeta) * 80}%`, width: `${(adjustment / superMeta) * 80}%` }}></div>
                  <div className="absolute top-0 bottom-0 border-r-2 border-emerald-500 z-10" style={{ left: `${(meta / superMeta) * 80}%` }} title="Meta"></div>
                </div>
                <div className="flex justify-between text-[10px] text-slate-400 mt-1">
                  <span>0</span>
                  <span className="text-emerald-600 font-bold" style={{ marginLeft: `${(meta / superMeta) * 80}%`, transform: 'translateX(-50%)' }}>Meta {meta}</span>
                  <span>Super {superMeta}</span>
                </div>
              </div>
            </div>
          );
        };

        // --- APLICAÇÃO PRINCIPAL ---
        function App() {
          const [user, setUser] = useState(null);
          const [offlineMode, setOfflineMode] = useState(false); // NOVO ESTADO PARA MODO OFFLINE
          const [activeTab, setActiveTab] = useState('dashboard');
          const [activeCategory, setActiveCategory] = useState('video');
          const [isEditing, setIsEditing] = useState(false);
          const [monthName, setMonthName] = useState('Novembro 2024');
          const [loading, setLoading] = useState(true);
          const [saving, setSaving] = useState(false);
          const [authError, setAuthError] = useState(null);
          const saveTimeoutRef = useRef(null);

          // Estado Inicial
          const initialData = {
            video: {
              goals: { min: 800, meta: 1000, super: 1200 },
              metrics: { pointsLastMonth: 950, revisionsLastMonth: 12, pointsCurrentMonth: 850, revisionsCurrentMonth: 5, pointsInApproval: 120, pointsInAdjustment: 45, tasksInEditing: 8, tasksInRecording: 3 }
            },
            art: {
              goals: { min: 400, meta: 600, super: 800 },
              metrics: { pointsLastMonth: 550, revisionsLastMonth: 8, pointsCurrentMonth: 450, revisionsCurrentMonth: 2, pointsInApproval: 80, pointsInAdjustment: 20, tasksInEditing: 12, tasksInBacklog: 15 }
            }
          };

          const [data, setData] = useState(initialData);
          const [history, setHistory] = useState([]);

          // 1. Autenticação COM CONTINGÊNCIA
          useEffect(() => {
            const initAuth = async () => {
              try {
                await signInAnonymously(auth);
              } catch (error) {
                console.warn("Falha na Autenticação Anônima:", error);
                // Se o erro for restrição de admin ou operação não permitida, ativa modo offline
                if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                  setAuthError("Modo Offline: Banco de dados não configurado para acesso anônimo.");
                  setOfflineMode(true);
                  setLoading(false); // Para de carregar para liberar a UI
                }
              }
            };
            initAuth();
            return onAuthStateChanged(auth, (u) => {
              if (u) {
                setUser(u);
                setAuthError(null);
                setOfflineMode(false);
              }
            });
          }, []);

          // 2. Leitura de Dados (Suporta Offline)
          useEffect(() => {
            // Se estiver offline, lê do LocalStorage
            if (offlineMode) {
              const savedLocal = localStorage.getItem('marketing_dash_data_v1');
              if (savedLocal) {
                setData(JSON.parse(savedLocal));
              }
              setLoading(false);
              return;
            }

            // Se estiver online, lê do Firebase
            if (!user) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'current_stats', 'main');
            const unsubscribe = onSnapshot(docRef, (docSnap) => {
              if (docSnap.exists()) {
                setData(docSnap.data());
              } else {
                setDoc(docRef, initialData).catch(() => {});
              }
              setLoading(false);
            }, (err) => {
              console.error("Erro leitura FB:", err);
              // Fallback se der erro de permissão mesmo logado
              if(err.code === 'permission-denied') {
                 setAuthError("Permissão negada no banco. Usando modo local.");
                 setOfflineMode(true);
              }
              setLoading(false);
            });
            return () => unsubscribe();
          }, [user, offlineMode]);

          // 3. Histórico (Suporta Offline)
          useEffect(() => {
            if (offlineMode) {
              const savedHistory = localStorage.getItem('marketing_dash_history_v1');
              if (savedHistory) {
                setHistory(JSON.parse(savedHistory));
              }
              return;
            }

            if (!user) return;
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'history_entries'));
            const unsubscribe = onSnapshot(q, (snapshot) => {
              const fetchedHistory = snapshot.docs.map(d => ({ firebaseId: d.id, ...d.data() }));
              fetchedHistory.sort((a, b) => b.id - a.id);
              setHistory(fetchedHistory);
            });
            return () => unsubscribe();
          }, [user, offlineMode]);

          // 4. Salvar Dados (Suporta Offline)
          const saveDataToFirebase = async (newData) => {
            if (offlineMode) {
              localStorage.setItem('marketing_dash_data_v1', JSON.stringify(newData));
              setSaving(false);
              return;
            }

            if (!user) return;
            setSaving(true);
            try {
              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'current_stats', 'main'), newData);
            } catch (e) { console.error(e); }
            finally { setSaving(false); }
          };

          const handleInputChange = (section, field, value) => {
            const numValue = value === '' ? 0 : Number(value);
            const newData = { ...data, [activeCategory]: { ...data[activeCategory], [section]: { ...data[activeCategory][section], [field]: numValue } } };
            setData(newData);
            if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
            saveTimeoutRef.current = setTimeout(() => saveDataToFirebase(newData), 1000);
          };

          const getInputValue = (val) => val === 0 ? '' : val;

          // Histórico Logic (Suporta Offline)
          const saveMonthToHistory = async () => {
            if (!user && !offlineMode) { alert("Conectando..."); return; }
            
            const existingEntry = history.find(item => item.month === monthName);
            const historyData = { id: Date.now(), month: monthName, dateSaved: new Date().toLocaleDateString('pt-BR'), data: { ...data } };

            if (offlineMode) {
               let newHistory;
               if (existingEntry) {
                 if (!window.confirm(`Atualizar histórico local de "${monthName}"?`)) return;
                 newHistory = history.map(h => h.month === monthName ? historyData : h);
               } else {
                 if (!window.confirm(`Salvar novo mês localmente: "${monthName}"?`)) return;
                 newHistory = [historyData, ...history];
               }
               // Ordena
               newHistory.sort((a, b) => b.id - a.id);
               setHistory(newHistory);
               localStorage.setItem('marketing_dash_history_v1', JSON.stringify(newHistory));
               alert("Salvo localmente (Modo Offline)!");
               return;
            }

            // Modo Online (Firebase)
            try {
              if (existingEntry) {
                if (!window.confirm(`Atualizar histórico na nuvem de "${monthName}"?`)) return;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history_entries', existingEntry.firebaseId), historyData);
                alert("Atualizado na nuvem!");
              } else {
                if (!window.confirm(`Salvar novo mês na nuvem: "${monthName}"?`)) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'history_entries'), historyData);
                alert("Salvo na nuvem!");
              }
            } catch (e) { alert("Erro ao salvar: " + e.message); }
          };

          const loadHistoryItem = (item) => {
            if (!window.confirm(`Carregar "${item.month}" no painel principal?`)) return;
            setData(item.data);
            saveDataToFirebase(item.data); // Salva no estado atual (local ou nuvem)
            setMonthName(item.month);
            setActiveTab('dashboard');
          };

          const deleteHistoryItem = async (item) => {
            if (!window.confirm("Excluir permanentemente?")) return;
            
            if (offlineMode) {
              const newHistory = history.filter(h => h.id !== item.id);
              setHistory(newHistory);
              localStorage.setItem('marketing_dash_history_v1', JSON.stringify(newHistory));
              return;
            }

            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'history_entries', item.firebaseId));
          };

          const currentData = data[activeCategory];
          const themeColor = activeCategory === 'video' ? 'indigo' : 'pink';
          const ThemeIcon = activeCategory === 'video' ? Video : Palette;

          if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-500"><RefreshCw className="animate-spin mr-2"/> Carregando Dash...</div>;

          return (
            <div className={`min-h-screen bg-slate-50 text-slate-800 font-sans pb-20 theme-${themeColor}`}>
              
              {/* Header */}
              <header className="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
                <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <div className={`p-2 rounded-lg ${activeCategory === 'video' ? 'bg-indigo-500' : 'bg-pink-500'}`}>
                      <BarChart3 className="text-white" size={20} />
                    </div>
                    <div>
                      <h1 className="text-lg md:text-xl font-bold">Metas Time de Marketing</h1>
                      <p className="text-xs text-slate-400 hidden md:block">{activeCategory === 'video' ? 'Vídeo & Motion' : 'Arte & Design'}</p>
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-3">
                    <div className={`hidden md:flex items-center gap-1 text-[10px] px-2 py-1 rounded uppercase tracking-wider ${offlineMode ? 'bg-amber-900 text-amber-200' : (user ? 'bg-slate-800 text-slate-400' : 'bg-red-900 text-red-200')}`}>
                      {offlineMode ? (
                         <><WifiOff size={10} /> MODO OFFLINE (LOCAL)</>
                      ) : user ? (
                         <>{saving ? <RefreshCw size={10} className="animate-spin" /> : <Cloud size={10} />} {saving ? 'Salvando...' : 'Online'}</>
                      ) : (<><AlertTriangle size={10} /> Conectando...</>)}
                    </div>
                    <nav className="flex bg-slate-800 p-1 rounded-lg">
                      <button onClick={() => setActiveTab('dashboard')} className={`px-3 py-1.5 rounded text-sm font-medium ${activeTab === 'dashboard' ? 'bg-slate-700 text-white' : 'text-slate-400'}`}>Dash</button>
                      <button onClick={() => setActiveTab('history')} className={`px-3 py-1.5 rounded text-sm font-medium ${activeTab === 'history' ? 'bg-slate-700 text-white' : 'text-slate-400'}`}>Histórico</button>
                    </nav>
                  </div>
                </div>
              </header>
              
              {/* Aviso de Erro / Modo Offline */}
              {authError && (
                <div className="bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 text-sm relative" role="alert">
                  <p className="font-bold">Atenção: Banco de Dados Desconectado</p>
                  <p>Para sincronizar na nuvem, ative o provedor <strong>"Anônimo"</strong> no Console do Firebase > Authentication.</p>
                  <p className="mt-1 text-xs">Enquanto isso, seus dados estão sendo salvos <strong>apenas neste navegador (LocalStorage)</strong>.</p>
                </div>
              )}

              <main className="max-w-7xl mx-auto px-4 py-8 space-y-8">
                {activeTab === 'dashboard' ? (
                  <>
                    {/* Controles */}
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-2 rounded-xl border border-slate-200 shadow-sm">
                      <div className="flex p-1 bg-slate-100 rounded-lg w-full md:w-auto">
                        <button onClick={() => setActiveCategory('video')} className={`flex-1 flex items-center justify-center gap-2 px-6 py-2 rounded-md text-sm font-bold transition-all ${activeCategory === 'video' ? 'bg-white text-indigo-700 shadow-sm' : 'text-slate-500'}`}>
                          <Video size={16} /> Vídeo
                        </button>
                        <button onClick={() => setActiveCategory('art')} className={`flex-1 flex items-center justify-center gap-2 px-6 py-2 rounded-md text-sm font-bold transition-all ${activeCategory === 'art' ? 'bg-white text-pink-700 shadow-sm' : 'text-slate-500'}`}>
                          <Palette size={16} /> Arte
                        </button>
                      </div>

                      <div className="flex flex-col sm:flex-row items-center gap-2 w-full md:w-auto justify-end">
                        <div className="flex items-center gap-2 w-full">
                          <input type="text" value={monthName} onChange={(e) => setMonthName(e.target.value)} className="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 flex-1" />
                          <button onClick={() => setIsEditing(!isEditing)} className={`p-2 rounded-lg border ${isEditing ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-slate-200 text-slate-600'}`}><Edit3 size={18} /></button>
                        </div>
                        <div className="flex items-center gap-1 w-full sm:w-auto">
                           <button onClick={saveMonthToHistory} className="flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800 transition-colors shadow-sm whitespace-nowrap" title="Salvar Mês no Histórico">
                            <PlusCircle size={16} /> <span className="text-sm font-bold">Salvar Histórico</span>
                          </button>
                        </div>
                      </div>
                    </div>

                    {/* Painel Edição */}
                    {isEditing && (
                      <div className={`bg-white border-l-4 border-${themeColor}-500 rounded-r-xl shadow-lg p-6 animate-in`}>
                        <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Edit3 size={16}/> Editar Dados ({activeCategory})</h3>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                          <div className="space-y-3">
                            <label className="text-xs font-bold text-slate-400 uppercase border-b pb-1 block">Metas</label>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Mínima</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.goals.min)} onChange={(e) => handleInputChange('goals', 'min', e.target.value)} /></div>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Meta</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.goals.meta)} onChange={(e) => handleInputChange('goals', 'meta', e.target.value)} /></div>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Super</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.goals.super)} onChange={(e) => handleInputChange('goals', 'super', e.target.value)} /></div>
                          </div>
                          <div className="space-y-3">
                            <label className="text-xs font-bold text-slate-400 uppercase border-b pb-1 block">Realizado</label>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Mês Atual</span><input type="number" className="w-full p-2 border rounded text-sm bg-slate-50 font-bold text-indigo-600" value={getInputValue(currentData.metrics.pointsCurrentMonth)} onChange={(e) => handleInputChange('metrics', 'pointsCurrentMonth', e.target.value)} /></div>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Passado</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.metrics.pointsLastMonth)} onChange={(e) => handleInputChange('metrics', 'pointsLastMonth', e.target.value)} /></div>
                          </div>
                          <div className="space-y-3">
                            <label className="text-xs font-bold text-slate-400 uppercase border-b pb-1 block">Qualidade</label>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Refações Atual</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.metrics.revisionsCurrentMonth)} onChange={(e) => handleInputChange('metrics', 'revisionsCurrentMonth', e.target.value)} /></div>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Refações Passado</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.metrics.revisionsLastMonth)} onChange={(e) => handleInputChange('metrics', 'revisionsLastMonth', e.target.value)} /></div>
                          </div>
                          <div className="space-y-3">
                            <label className="text-xs font-bold text-slate-400 uppercase border-b pb-1 block">Pipeline</label>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Aprovação</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.metrics.pointsInApproval)} onChange={(e) => handleInputChange('metrics', 'pointsInApproval', e.target.value)} /></div>
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Ajuste</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.metrics.pointsInAdjustment)} onChange={(e) => handleInputChange('metrics', 'pointsInAdjustment', e.target.value)} /></div>
                            {activeCategory === 'video' ? (
                               <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Gravação</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.metrics.tasksInRecording)} onChange={(e) => handleInputChange('metrics', 'tasksInRecording', e.target.value)} /></div>
                            ) : (
                               <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Backlog</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.metrics.tasksInBacklog)} onChange={(e) => handleInputChange('metrics', 'tasksInBacklog', e.target.value)} /></div>
                            )}
                            <div><span className="text-[10px] font-bold text-slate-500 block mb-1">Em Edição</span><input type="number" className="w-full p-2 border rounded text-sm" value={getInputValue(currentData.metrics.tasksInEditing)} onChange={(e) => handleInputChange('metrics', 'tasksInEditing', e.target.value)} /></div>
                          </div>
                        </div>
                      </div>
                    )}

                    <Card className="border-t-4 border-t-slate-900 shadow-md">
                      <GoalTracker current={currentData.metrics.pointsCurrentMonth} approval={currentData.metrics.pointsInApproval} adjustment={currentData.metrics.pointsInAdjustment} min={currentData.goals.min} meta={currentData.goals.meta} superMeta={currentData.goals.super} themeColor={themeColor} />
                    </Card>

                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                      <StatCard title="Em Aprovação" value={currentData.metrics.pointsInApproval} icon={CheckCircle2} colorClass="text-blue-600 bg-blue-50" subtext="Pts aguardando" />
                      <StatCard title="Refações" value={currentData.metrics.revisionsCurrentMonth} icon={AlertCircle} colorClass="text-red-600 bg-red-50" subtext="Mês Atual" />
                      <StatCard title="Em Edição" value={currentData.metrics.tasksInEditing} icon={Scissors} colorClass={`text-${themeColor}-600 bg-${themeColor}-50`} subtext="Tarefas ativas" />
                      {activeCategory === 'video' ? (
                         <StatCard title="Gravação" value={currentData.metrics.tasksInRecording} icon={Video} colorClass="text-rose-600 bg-rose-50" subtext="Aguardando material" />
                      ) : (
                         <StatCard title="Backlog" value={currentData.metrics.tasksInBacklog} icon={Layers} colorClass="text-slate-600 bg-slate-100" subtext="Fila de espera" />
                      )}
                    </div>

                     <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                       <Card>
                         <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-700 flex gap-2"><TrendingUp size={18}/> Volume vs Mês Passado</h3></div>
                         <div className="flex items-end gap-4 h-32">
                            <div className="flex-1 flex flex-col justify-end items-center gap-2">
                               <div className="font-bold text-slate-400">{currentData.metrics.pointsLastMonth}</div>
                               <div className="w-full bg-slate-200 rounded-t-lg" style={{ height: '60%' }}></div>
                               <div className="text-xs text-slate-400 uppercase">Anterior</div>
                            </div>
                            <div className="flex-1 flex flex-col justify-end items-center gap-2">
                               <div className={`font-bold text-${themeColor}-600`}>{currentData.metrics.pointsCurrentMonth}</div>
                               <div className={`w-full bg-${themeColor}-500 rounded-t-lg shadow-lg transition-all duration-1000`} style={{ height: `${Math.min((currentData.metrics.pointsCurrentMonth/Math.max(currentData.metrics.pointsLastMonth, 1))*60, 100)}%` }}></div>
                               <div className="text-xs text-slate-800 font-bold uppercase">Atual</div>
                            </div>
                         </div>
                       </Card>
                       <Card>
                          <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-700 flex gap-2"><Award size={18}/> Metas Batidas</h3></div>
                          <div className="space-y-4">
                            <div className={`p-3 rounded-lg flex justify-between items-center ${currentData.metrics.pointsCurrentMonth >= currentData.goals.min ? 'bg-amber-100 text-amber-800' : 'bg-slate-50 text-slate-400'}`}><span className="font-bold text-sm">Mínima ({currentData.goals.min})</span>{currentData.metrics.pointsCurrentMonth >= currentData.goals.min ? <CheckCircle2 size={18}/> : <span className="text-xs">Pendente</span>}</div>
                            <div className={`p-3 rounded-lg flex justify-between items-center ${currentData.metrics.pointsCurrentMonth >= currentData.goals.meta ? 'bg-emerald-100 text-emerald-800' : 'bg-slate-50 text-slate-400'}`}><span className="font-bold text-sm">Meta ({currentData.goals.meta})</span>{currentData.metrics.pointsCurrentMonth >= currentData.goals.meta ? <CheckCircle2 size={18}/> : <span className="text-xs">Pendente</span>}</div>
                            <div className={`p-3 rounded-lg flex justify-between items-center ${currentData.metrics.pointsCurrentMonth >= currentData.goals.super ? 'bg-purple-100 text-purple-800' : 'bg-slate-50 text-slate-400'}`}><span className="font-bold text-sm">Super Meta ({currentData.goals.super})</span>{currentData.metrics.pointsCurrentMonth >= currentData.goals.super ? <Trophy size={18}/> : <span className="text-xs">Pendente</span>}</div>
                          </div>
                       </Card>
                     </div>
                  </>
                ) : (
                  <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><HistoryIcon className="text-slate-400"/> Histórico</h2>
                    {history.length === 0 && <div className="text-center py-10 text-slate-400">Nenhum histórico salvo.</div>}
                    {history.map(item => (
                      <Card key={item.id} className="flex justify-between items-center group relative overflow-hidden">
                        <button onClick={() => deleteHistoryItem(item)} className="absolute right-0 top-0 h-full w-12 bg-red-50 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center z-10">×</button>
                        <div>
                          <h3 className="font-bold text-lg">{item.month}</h3>
                          <div className="text-xs text-slate-400">Salvo em {item.dateSaved}</div>
                          <button onClick={() => loadHistoryItem(item)} className="mt-2 text-xs flex items-center gap-1 bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition-colors font-medium"><Upload size={12} /> Carregar no Dash</button>
                        </div>
                        <div className="flex gap-8 text-right pr-8">
                          <div><div className="text-[10px] font-bold text-slate-400 uppercase">Vídeo</div><div className="font-bold text-indigo-600">{item.data.video.metrics.pointsCurrentMonth} pts</div></div>
                          <div><div className="text-[10px] font-bold text-slate-400 uppercase">Arte</div><div className="font-bold text-pink-600">{item.data.art.metrics.pointsCurrentMonth} pts</div></div>
                        </div>
                      </Card>
                    ))}
                  </div>
                )}
              </main>
              
              {/* Diagnóstico de Salvamento */}
              <footer className="max-w-7xl mx-auto px-4 py-4 text-center border-t border-slate-200 mt-8">
                <div className={`inline-flex items-center gap-2 text-[10px] px-3 py-1 rounded-full ${offlineMode ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-400'}`}>
                  <Database size={12} />
                  <span>Salvando em: <strong>{offlineMode ? 'Navegador Local' : `artifacts/${appId}/public/data`}</strong></span>
                </div>
              </footer>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>